---
- name: "V1 - Installation Docker (version ultra-simple)"
  hosts: sysops
  become: yes
  gather_facts: yes
  
  vars:
    docker_compose_version: "v2.24.1"
    work_directories:
      - /opt/applications
      - /opt/data
      - /opt/logs

  tasks:
    - name: "ğŸ§¹ Suppression des anciennes versions de Docker"
      package:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
      ignore_errors: yes

    - name: "ğŸ³ Installation Docker via script officiel"
      shell: |
        curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
        sh /tmp/get-docker.sh
        rm /tmp/get-docker.sh
      args:
        creates: /usr/bin/docker

    - name: "ğŸš€ DÃ©marrage et activation de Docker"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ‘¥ Ajout de root au groupe docker"
      user:
        name: root
        groups: docker
        append: yes

    - name: "ğŸ“ CrÃ©ation des dossiers de travail"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ work_directories }}"

    - name: "â¬‡ï¸ Installation Docker Compose"
      get_url:
        url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: "ğŸ” Test installation"
      command: "{{ item }}"
      register: version_check
      changed_when: false
      loop:
        - docker --version
        - docker-compose --version
      
    - name: "âœ… Versions installÃ©es"
      debug:
        msg: "{{ version_check.results | map(attribute='stdout') | list }}"

    - name: "ğŸ§ª Test Hello World"
      command: docker run --rm hello-world
      register: hello_test
      changed_when: false

    - name: "ğŸ‰ Installation rÃ©ussie"
      debug:
        msg: "âœ… Docker est opÃ©rationnel !"

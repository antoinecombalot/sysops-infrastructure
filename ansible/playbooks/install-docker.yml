---
- name: "V1 - Installation automatisÃ©e de Docker"
  hosts: sysops
  become: yes
  gather_facts: yes
  
  vars:
    docker_compose_version: "v2.24.1"
    system_packages:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    work_directories:
      - /opt/applications
      - /opt/data
      - /opt/logs

  tasks:
    - name: "ğŸ” DÃ©tection de l'utilisateur actuel"
      command: whoami
      register: current_user
      changed_when: false
      become: no

    - name: "ğŸ“ DÃ©finition de la variable utilisateur"
      set_fact:
        target_user: "{{ current_user.stdout }}"

    - name: "ğŸ§¹ Suppression des anciennes versions de Docker"
      package:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
      ignore_errors: yes

    - name: "ğŸ“¦ Installation des paquets systÃ¨me requis"
      apt:
        name: "{{ system_packages }}"
        state: present
        update_cache: yes

    - name: "ğŸ“ CrÃ©ation du dossier pour les clÃ©s GPG"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: "ğŸ” TÃ©lÃ©chargement de la clÃ© GPG Docker (mÃ©thode moderne)"
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /tmp/docker.gpg
        mode: '0644'

    - name: "ğŸ”‘ Installation de la clÃ© GPG Docker"
      command: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /tmp/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: "ğŸ”§ DÃ©finition des permissions de la clÃ©"
      file:
        path: /etc/apt/keyrings/docker.gpg
        mode: '0644'

    - name: "ğŸ“‹ Ajout du dÃ©pÃ´t Docker pour Debian (mÃ©thode moderne)"
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_lsb.codename }} stable"
        state: present
        update_cache: yes

    - name: "ğŸ³ Installation de Docker CE"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: "ğŸš€ DÃ©marrage et activation de Docker"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ‘¥ Ajout de l'utilisateur au groupe docker"
      user:
        name: "{{ target_user }}"
        groups: docker
        append: yes

    - name: "ğŸ“ CrÃ©ation des dossiers de travail"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
      loop: "{{ work_directories }}"

    - name: "â¬‡ï¸ Installation Docker Compose standalone"
      get_url:
        url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
        owner: root
        group: root

    - name: "ğŸ§¹ Nettoyage du fichier GPG temporaire"
      file:
        path: /tmp/docker.gpg
        state: absent

    - name: "ğŸ” VÃ©rification de l'installation Docker"
      command: docker --version
      register: docker_version
      changed_when: false

    - name: "ğŸ” VÃ©rification de Docker Compose (plugin)"
      command: docker compose version
      register: docker_compose_plugin_version
      changed_when: false

    - name: "ğŸ” VÃ©rification de Docker Compose (standalone)"
      command: docker-compose --version
      register: docker_compose_standalone_version
      changed_when: false

    - name: "âœ… Affichage des informations d'installation"
      debug:
        msg:
          - "Utilisateur configurÃ©: {{ target_user }}"
          - "Docker: {{ docker_version.stdout }}"
          - "Docker Compose Plugin: {{ docker_compose_plugin_version.stdout }}"
          - "Docker Compose Standalone: {{ docker_compose_standalone_version.stdout }}"

    - name: "ğŸ§ª Test Docker avec Hello World"
      command: docker run --rm hello-world
      register: hello_world_output
      changed_when: false

    - name: "ğŸ‰ SuccÃ¨s du test Docker"
      debug:
        msg: 
          - "âœ… Docker fonctionne correctement !"
          - "Utilisateur {{ target_user }} ajoutÃ© au groupe docker"
      when: "'Hello from Docker!' in hello_world_output.stdout"

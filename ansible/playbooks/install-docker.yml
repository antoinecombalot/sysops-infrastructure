---
- name: "V1 - Installation automatisÃ©e de Docker"
  hosts: sysops
  become: yes
  gather_facts: yes

  tasks:
    - name: "ğŸ§¹ Suppression des anciennes versions de Docker"
      package:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
      ignore_errors: yes

    - name: "ğŸ“¦ Installation des paquets systÃ¨me requis"
      apt:
        name: "{{ system_packages }}"
        state: present
        update_cache: yes

    - name: "ğŸ” Ajout de la clÃ© GPG Docker"
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: "ğŸ“‹ Ajout du dÃ©pÃ´t Docker"
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        state: present
        update_cache: yes

    - name: "ğŸ³ Installation de Docker CE"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: "ğŸš€ DÃ©marrage et activation de Docker"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ‘¥ Ajout de l'utilisateur au groupe docker"
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users }}"

    - name: "ğŸ“ CrÃ©ation des dossiers de travail"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ work_directories }}"

    - name: "â¬‡ï¸ Installation Docker Compose standalone"
      get_url:
        url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
        owner: root
        group: root

    - name: "ğŸ” VÃ©rification de l'installation Docker"
      command: docker --version
      register: docker_version
      changed_when: false

    - name: "ğŸ” VÃ©rification de Docker Compose (plugin)"
      command: docker compose version
      register: docker_compose_plugin_version
      changed_when: false

    - name: "ğŸ” VÃ©rification de Docker Compose (standalone)"
      command: docker-compose --version
      register: docker_compose_standalone_version
      changed_when: false

    - name: "âœ… Affichage des versions installÃ©es"
      debug:
        msg:
          - "Docker: {{ docker_version.stdout }}"
          - "Docker Compose Plugin: {{ docker_compose_plugin_version.stdout }}"
          - "Docker Compose Standalone: {{ docker_compose_standalone_version.stdout }}"

    - name: "ğŸ§ª Test Docker avec Hello World"
      command: docker run --rm hello-world
      register: hello_world_output
      changed_when: false

    - name: "ğŸ‰ SuccÃ¨s du test Docker"
      debug:
        msg: "âœ… Docker fonctionne correctement !"
      when: "'Hello from Docker!' in hello_world_output.stdout"
